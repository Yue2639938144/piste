# PISTE

## Introduction

<p>Physics-Inspired Transformer Neural Architecture for TCR-Antigen-HLA Binding Prediction and Personalized Neoantigen Screening.</p>


## Installation

<pre>
<code>Command:
> cd ./PISTE/code #enter the current directory
> conda create -n piste python=3.6
> conda activate piste 
> conda install pytorch==1.10.2 torchvision==0.11.3 torchaudio==0.10.2 cudatoolkit==11.3.1 -c pytorch -c conda-forge  
> pip install numpy==1.19.2 pandas==1.1.5 scikit_learn==0.20.2 scipy==1.5.4 tqdm==4.64.1 
</code>
</pre>
#### * Note : The installation of pytorch needs to correspond to your system, GPU and other versions, please check https://pytorch.org/get-started/locally/. 



## Usage

### 1. Demo of making predictions .
<p>The well-trained models are saved in <code>/code/checkpoints/*</code>. These models were trained under different negative-data sampling schemes (with positive-versus-negative sample ratio as 1:10). <code>predict.py</code> is used for making predictions using well-trained models. </p>

<pre>
<code>Usage: python predict.py [options]  
Required:
--input STRING: the path to the input data file (*.csv). 
--output STRING: the directory to save the prediction results, output as CSV files.

Optional:
--model_name STRING: choose different trained model by using datasets generated by different negative sampling (choices: random, unipep, reftcr).
--threshold STRING: the threshold to define binder based on predicted score, ranging from 0 - 1 (default:0.5). 
--antigen_type STRING: choose mutant antigen or wild-type antigen (choices: MT, WT).
</code> 
</pre>

We provide a small demo example to test the installation of the PISTE and to show you how to use PISTE to predict the HLA-antigen-TCR binding.

<pre>
<code>
python predict.py --input ../data/demo/example.csv --output ../data/demo/ --model_name unipep --threshold 0.5 --antigen_type MT

</code>
</pre>

* --input *.csv file contains four columns: 'CDR3', 'MT_pep', 'HLA_type',and 'HLA_sequence' which represents the TCR CDR3 squence, antigen sequence, HLA-I allele and HLA pseudo-sequences respectively. If 'HLA_sequence' not in columns,the program will automatically match the HLA pseudo-sequence corresponding to the HLA-I allele.
* --output *.csv file contains six columns: 'CDR3', 'MT_pep', 'HLA_type',and 'HLA_sequence', 'predicted_label' and 'predicted_score', which represents the TCR CDR3 squence, antigen sequence, HLA-I allele, HLA pseudo-sequence and their predicted binding label and score. All the TCR-antigen-HLA triples are the triples in the input file. 



### 2. Evaluate PISTE on test datasets with well-trained models.

<p>The selection and meaning of the parameters are the same as the 5th section  below</p>

<p> If you want to evaluate PISTE on two test-sets that produced by different negative sampling methods separately, you can run the commands as follows:</p>

<pre>
<code># unified-peptide
python test.py --data_name unipep

# reference TCR
python test.py --data_name reftcr

# random shuffling 
python test.py --data_name random 
</code></pre>

<code>--data_name</code> indicates datasets generated by different negative sampling methods. The test data for each of the three sampling strategies has been stored in its own folder after the process of 'Produce negative samples (triples) from raw positive data'. 
</p> 



### 3. Neoantigen screening process.

<p> 1) <code>combin_hla_pep_tcr.py</code> in <code>PeptideScreen</code> dir is used for obtain all possible TCR-Antigen-HLA triples for the patient.

<pre>
<code>Usage: python combin_hla_pep_tcr.py [options]  
Required:
--peptide_file STRING: the path of peptide-HLA file drived from patient (*.csv). 
--TCR_file STRING: the path of TCR file drived from patient (*.csv). 
--output STRING: the directory to save the prediction results, output as CSV files. 
--sample_id STRING: the type of genetic mutation in the patient's tumor (choices: snv, indel).
</code> 
</pre>

Use the patient PCA1 as an example: 

<pre>
<code># Get HLA-antigen-TCR triples for SNV mutation
python ./PeptideScreen/combin_hla_pep_tcr.py --peptide_file ../data/PCA_data/phla/PCA1/snv.csv --TCR_file ../data/PCA_data/TCR/PCA1/TCR.csv --output_dir ../data/PCA_data/triples/PCA1 --sample_id snv 

# Get HLA-antigen-TCR triples for Indel mutation
python ./PeptideScreen/combin_hla_pep_tcr.py --peptide_file ../data/PCA_data/phla/PCA1/indel.csv --TCR_file ../data/PCA_data/TCR/PCA1/TCR.csv --output_dir ../data/PCA_data/triples/PCA1 --sample_id indel</code>
</pre>

You can change the file path for other patients, e.g. <code>--peptide_file ../data/PCA_data/phla/PCA2/snv.csv</code>. </p>

<p> 2) Then, predict the binding status of triples for mutate neoantigen by using <code>predict.py</code>: </p>


Use the patient PCA1 as an example: 
<pre>
<code># Neoantigens binding prediction for SNV mutation
python predict.py --input ../data/PCA_data/triples/PCA1/snv_phla_tcr.csv --threshold 0.5 --antigen_type MT --output ../data/PCA_data/predicted_results/MT/PCA1

# Neoantigens binding prediction for Indel mutation
python predict.py --input ../data/PCA_data/triples/PCA1/indel_phla_tcr.csv --threshold 0.5 --antigen_type MT --output ../data/PCA_data/predicted_results/MT/PCA1/indel</code>
</pre>

<p> 3) Next, predict the binding status of triples for wild-type antigen by using <code>predict.py</code>: </p>

Use the patient PCA1 as an example: 
<pre>
<code># Wild-type antigen binding prediction for SNV mutation
python predict.py --input ../data/PCA_data/triples/PCA1/snv_phla_tcr.csv --threshold 0.5 --antigen_type WT --output ..data/PCA_data/predicted_results/WT/PCA1

# Wild-type antigen binding prediction for Indel mutation
python predict.py --input ../data/PCA_data/triples/PCA1/indel_phla_tcr.csv --threshold 0.5 --antigen_type WT --output ../data/PCA_data/predicted_results/WT/PCA1/indel</code>
</pre>

<p> 4) Finally, obtain the ranking of neoantigens by running <code>peptide_ranking.py</code> in <code>PeptideScreen</code> dir :</p>

<pre>
<code>Usage: python peptide_ranking.py [options]  
Required:
--mtpeptide_file STRING: the path of mutate neoantigens prediction file after the second step (*.csv). 
--wtpeptide_file STRING: the path of wild-type antigens prediction file after the third step (*.csv). 
--output_dir STRING: the directory to save the ranking results, output as CSV files. 
--sample_id STRING: the type of genetic mutation in the patient's tumor (choices: snv, indel).
</code> 
</pre>


Use the patient PCA1 as an example: 
<pre>
<code># Neoantigen screening for SNV mutation
python ./PeptideScreen/peptide_ranking.py --mtpeptide_file ../data/PCA_data/predicted_results/MT/PCA1/pre_out.csv --wtpeptide_file ../data/PCA_data/predicted_results/WT/PCA1/pre_out.csv --output_dir ../data/PCA_data/screened_immun_antigen/PCA1 --sample_id snv

# Neoantigen screening for Indel mutation
python ./PeptideScreen/peptide_ranking.py --mtpeptide_file ../data/PCA_data/predicted_results/MT/PCA1/indel/pre_out.csv --wtpeptide_file ../data/PCA_data/predicted_results/WT/PCA1/indel/pre_out.csv --output_dir ../data/PCA_data/screened_immun_antigen/PCA1 --sample_id indel</code>
</pre>

### 4. Produce negative samples (triples) from raw positive data. 

<p> The raw positive data are saved in <code>/data/raw_data/*</code>. We offer 3 ways to generate negative samples, including random shuffling, unified-peptide and reference TCR. 
You can generate the negative samples by using <code>/code/Datasets/sampler.py</code>. 

<pre>
<code>Usage: python sampler.py [options]  
Required:
--pos STRING: the path to the positive data file (*.csv).
--neg STRING: the path to the generated negative data file (*.csv).
the path to the negative data file (*.csv).
--sampling STRING: the negative sampling method (choices: random, unipep, reftcr).
--ref_tcr STRING: the path to the reference TCR data file (*.csv).
--file_type STRING: type of the data set, you can choose training or test.
Optional:
--neg_ratio INT: the ratio of negative samples (defalt: 10). 
</code> 
</pre> 


For example, if you want to generate negative samples (10 times as many as positive samples) for training data via random shuffling, you can run the following command: </p> 

<pre><code> python ./Dataset/sampler.py --pos ../data/raw_data/pos_training_data.csv --neg ../../data/raw_data/neg_training_data.csv --sampling shuffle --file_type training --neg_ratio 10</code></pre>

<p> Then we partition the whole training data into 80/20 training/validation subsets, and store them in <code>/data/random/</code>. You can replace <code>--sampling shuffle</code> with <code>--sampling unipep </code> or <code>--sampling reftcr</code> 
to generate negative samples via unified-peptide or reference TCR for training data. 
<p> Besides, you can use <code>--file_type testing</code> to generate negative samples for testing data. All test samples (three groups) that encountered antigen-HLA pairs in the training dataset are automatically excluded (by the <code>drop_duplicate function</code>). </p>

<p> For convenience, we provide the training dataset we produced in <code>/data/*</code>. The detailed commands to generate all datasets used in the paper can be seen in <code> prepare_data.sh</code>. </p>

### 5. Retrain PISTE on new datasets.

<p>The <code>main.py</code> is used to train PISTE. 
<pre>
<code>
Usage: main.py [options]
Required: 
--data_name STRING: choose different datasets generated by different negative samplings (choices:'random', 'unipep', 'reftcr').
Optional:
--data_dir STRING: the root path of data files (default='../data/').
--output_dir STRING: the path to save the model (default="./checkpoints/new/").
--pep_max_len INT: the max length of peptide sequence (default:11). 
--hla_max_len INT: the max length of HLA sequence (default:34).
--tcr_max_len INT: the max length of TCR sequence (default:30).
--batch_size INT: the number of batch size(defult:1024).
--epochs INT: The number of epochs (default:200).
--threshold FLOAT: the threshold for the classifier (default:0.5).
--device STRING: set the device (default:CUDA).
--alpha FLOAT: parameter of focal loss (default:0.75).
--gamma FLOAT: parameter of focal loss (default:2).
--lr FLOAT: the learning rate (default:1e-3).
--d_model INT: the dimension of embedding space (default:64).
--e_layers INT: the number of encoder layers (default:3).
--dim INT: the dimension of sliding attention (defult:64).
--n_heads INT: the number of attention heads (default:9).
--sigma INT: the bandwidth of space matrix (defult:1).
--window_size STRING: the parameter to control the window size during the sliding process (choices:'1','2','3','4').
--interact_layers INT: the number of sliding attention layers(default=1). 
--d_layers INT: the number of decoder layers (defult=1).
--exp INT: the number of times the training model was repeated (defult=1).

</code>
</pre>
You can change <code>--data_name</code> according to the method to generate negative samples for your new training dataset. 

For example, if you use the unified-peptide method to produce negative samples, you can run this command to retrain PISTE:  
</p>

<pre>
<code># unified-peptide
python main.py --data_name unipep
</code></pre>

<p>You can change the default hyper-parameters in <code>main.py</code>. After training, <code>main.py</code> will automatically evaluate the PISTE model on the test datasets specified, and output three metrics: AUROC, AUPR and PPVn.</p>
